name: Fetch CDS (SBSR)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 11 * * 2"  # Tue 06:30 ET (avoid peak hours)

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Probe coverage
        run: |
          python cds_one_stop.py probe

      - name: Yearly pulls (2012 â†’ 2024Q3) with SBSR clipping
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/partial
          for Y in $(seq 2012 2024); do
            start="${Y}-01-01"
            end="${Y}-12-31"
            if [ "$Y" = "2024" ]; then end="2024-09-30"; fi
            echo "== Year $Y =="
            python cds_one_stop.py fetch \
              --entity "United States of America" \
              --tenor-years 5 \
              --currency USD \
              --start "$start" \
              --end "$end" \
              --agg weighted_mean \
              --out "data/partial/us_5y_cds_${Y}.csv"
          done

      - name: Merge partials
        shell: python
        run: |
          import pathlib, pandas as pd, glob
          files = sorted(glob.glob("data/partial/us_5y_cds_*.csv"))
          if not files:
              raise SystemExit("No partials were written")
          dfs = [pd.read_csv(f) for f in files]
          all_ = pd.concat(dfs, ignore_index=True)
          all_["date"] = pd.to_datetime(all_["date"], errors="coerce").dt.date
          all_ = all_.dropna(subset=["date"]).sort_values("date")
          all_ = all_.drop_duplicates(subset=["date"], keep="last")
          pathlib.Path("data").mkdir(parents=True, exist_ok=True)
          all_.to_csv("data/us_5y_cds.csv", index=False)
          print("Wrote data/us_5y_cds.csv", len(all_), "rows")

      - name: Commit dataset
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "data: update us_5y_cds (SBSR clipped to 2021-11-08+)"
          file_pattern: |
            data/us_5y_cds.csv
            data/partial/*.csv
