name: Fetch US 5Y CDS (2012–Q3 2024)

on:
  workflow_dispatch: {}
  # optional: refresh weekly (Mon 01:30 UTC)
  schedule:
    - cron: "30 1 * * 1"

permissions:
  contents: write

concurrency:
  group: cds-download
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Ensure data folder
        run: mkdir -p data

      - name: Fetch US 5Y CDS time series (2012-01-01 → 2024-09-30)
        run: |
          python cds_one_stop.py fetch \
            --entity "United States of America" \
            --tenor-years 5 \
            --currency USD \
            --start 2012-01-01 \
            --end   2024-09-30 \
            --agg weighted_mean \
            --out data/us_5y_cds_2012_2024Q3.csv

      - name: Commit & push if data changed
        run: |
          set -e
          if git status --porcelain -- data/us_5y_cds_2012_2024Q3.csv | grep -q .; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/us_5y_cds_2012_2024Q3.csv
            git commit -m "CDS: refresh US 5Y (2012–Q3 2024)"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: us_5y_cds_2012_2024Q3
          path: data/us_5y_cds_2012_2024Q3.csv
