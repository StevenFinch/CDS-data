name: Fetch CDS (USA 5Y) and merge

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 1 * * 1-5"   # 01:30 UTC, weekdays

permissions:
  contents: write

jobs:
  fetch-cds:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Fetch by year 2012â€“2024Q3
        shell: bash
        run: |
          mkdir -p data/partial
          for Y in $(seq 2012 2024); do
            start="${Y}-01-01"; end="${Y}-12-31"
            if [ "$Y" = "2024" ]; then end="2024-09-30"; fi
            echo "=== Year $Y ==="
            python cds_one_stop.py \
              --start "$start" \
              --end "$end" \
              --agg weighted_mean \
              --out "data/partial/us_5y_cds_${Y}.csv" || true
          done

      - name: Merge partials -> data/us_5y_cds.csv
        shell: python
        run: |
          import pathlib, glob, pandas as pd
          p = pathlib.Path("data")
          p.mkdir(parents=True, exist_ok=True)
          files = sorted(glob.glob("data/partial/us_5y_cds_*.csv"))
          if not files:
              print("No partials found; writing empty header")
              pd.DataFrame(columns=["date","entity","tenor_years","currency","trades","notional","price_bps_weighted_mean"]).to_csv("data/us_5y_cds.csv", index=False)
          else:
              dfs = [pd.read_csv(f) for f in files if pathlib.Path(f).stat().st_size > 0]
              if dfs:
                  all_ = pd.concat(dfs, ignore_index=True)
                  all_["date"] = pd.to_datetime(all_["date"]).dt.date
                  all_ = all_.sort_values("date").drop_duplicates(subset=["date"], keep="last")
                  all_.to_csv("data/us_5y_cds.csv", index=False)
                  print("Wrote data/us_5y_cds.csv", len(all_))
              else:
                  pd.DataFrame(columns=["date","entity","tenor_years","currency","trades","notional","price_bps_weighted_mean"]).to_csv("data/us_5y_cds.csv", index=False)

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "CDS: refresh USA 5Y (auto)" || echo "no changes"
          git push
